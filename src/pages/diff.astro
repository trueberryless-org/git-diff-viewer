---
import Layout from "../layouts/Layout.astro";
import { html as diff2html } from "diff2html";

// --- Inputs from query parameters ---
const repo = Astro.url.searchParams.get("repo") || "";
const file = Astro.url.searchParams.get("file") || "";
const since = Astro.url.searchParams.get("since") || "";

// --- Diff2Html options from query parameters ---
const sideBySide = Astro.url.searchParams.get("sideBySide") === "true";
const outputFormat = sideBySide ? "side-by-side" : "line-by-line";

let diffHtml = "";

if (repo && file && since) {
  try {
    const origin = new URL(Astro.request.url).origin;
    const res = await fetch(
      `${origin}/api/diff?repo=${repo}&file=${file}&since=${since}`
    );
    const data = await res.json();
    const diffText = data.diff || data.error || "";

    if (diffText) {
      diffHtml = diff2html(diffText, {
        outputFormat,
        drawFileList: false,
        matching: "lines",
        // @ts-ignore
        colorScheme: "dark",
      });
    }
  } catch (e) {
    // @ts-ignore
    diffHtml = `<p>Error: ${e.message}</p>`;
  }
}
---

<Layout>
  <h1>Diff for {repo}/{file} since {since}</h1>

  <!-- Checkbox to toggle side-by-side view -->
  <form method="get" id="diffOptionsForm" style="margin-bottom:1rem;">
    <input type="hidden" name="repo" value={repo} />
    <input type="hidden" name="file" value={file} />
    <input type="hidden" name="since" value={since} />

    <label>
      <input 
        type="checkbox" 
        name="sideBySide" 
        value="true" 
        checked={sideBySide} 
        onchange="this.form.submit()" 
      />
      Side by Side
    </label>
  </form>

  {diffHtml ? (
    <div class="diff2html-wrapper" set:html={diffHtml}></div>
  ) : (
    <p>No data.</p>
  )}
</Layout>

<style is:global>
  :is(.d2h-code-linenumber,.d2h-code-side-linenumber) {
    cursor: default;
    height: 20px;
  }
  .d2h-code-linenumber>div {
    padding: 1px 0.5em;
  }
  .d2h-code-side-linenumber {
    padding: 2px 0.5em;
  }
  :is(.d2h-code-linenumber,.d2h-code-side-linenumber).d2h-info {
    background-color: hsl(from var(--d2h-dark-info-bg-color) h calc(s - 50) calc(l - 44) / 1) !important;
  }
  :is(.d2h-code-linenumber,.d2h-code-side-linenumber).d2h-ins {
    background-color: hsl(from var(--d2h-dark-ins-bg-color) h calc(s - 25) calc(l - 22) / 1) !important;
  }
  :is(.d2h-code-linenumber,.d2h-code-side-linenumber).d2h-del {
    background-color: hsl(from var(--d2h-dark-del-bg-color) h calc(s - 50) calc(l - 44) / 1) !important;
  }
</style>
